---
- name: Configure Sonar Scanner Path and set JAVA_HOME
  hosts: jenkins
  become: true  
  vars:
    jenkins_host: "http://{{ ansible_host }}:8080"  
    jenkins_user: "admin"  
    sonar_name: "SonarQube"  
    sonar_server_url: "http://{{ ansible_host }}:9000"  

  tasks:
    - name: Read Jenkins API token from api-token.txt
      ansible.builtin.slurp:
        src: /tmp/api_token.txt  
      register: api_token

    - name: Set Jenkins password from decoded token
      set_fact:
        jenkins_password: "{{ (api_token.content | b64decode | from_json).data.tokenValue }}"

    - name: Read SonarQube token from sonar_token.txt
      ansible.builtin.slurp:
        src: /tmp/sonarqube_token.txt  
      register: sonar_token

    - name: Set SonarQube auth token from decoded content
      set_fact:
        sonar_auth_token: "{{ sonar_token.content | b64decode }}"

    - name: Set JAVA_HOME in /etc/environment
      lineinfile:
        path: /etc/environment
        line: 'JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64'
        state: present

    - name: Get Jenkins Crumb
      uri:
        url: "{{ jenkins_host }}/crumbIssuer/api/json"  
        method: GET
        user: "{{ jenkins_user }}"
        password: "{{ jenkins_password }}"
        force_basic_auth: yes
        return_content: yes
      register: jenkins_crumb

    - name: Install python-jenkins
      pip:
        name: python-jenkins
        state: present
        executable: pip3

    - name: Check for python-jenkins
      command: /opt/venv/bin/python -c "import jenkins"
      register: result
      ignore_errors: yes

    - debug:
        var: result.stderr

    - name: Read API token from file
      slurp:
        src: /tmp/api_token.txt  
      register: token_file

    - name: Set the API token variable
      set_fact:
        api_token: "{{ (token_file.content | b64decode | from_json).data.tokenValue }}"

    - name: Configure Global Tool Configuration for SonarQube Scanner
      jenkins_job:
        name: "SonarQube Scanner"
        config: |
          <project>
            <builders>
              <hudson.plugins.sonar.SonarRunnerBuilder>
                <properties>
                  <sonarScannerHome>/opt/sonar-scanner</sonarScannerHome>
                </properties>
              </hudson.plugins.sonar.SonarRunnerBuilder>
            </builders>
          </project>
        state: present
        url: "http://{{ ansible_host }}:8080"  
        user: "admin"                     
        token: "{{ api_token }}"           
      register: result

    - debug:
        var: result